# 开源依赖集成执行计划

## 当前状态分析

### 已实现 ✅
| 功能 | 实现方式 | 状态 |
|-----|---------|------|
| 音频特征分析 | Meyda | ✅ 完整集成 |
| 预设推荐 | 自研 Bandit | ✅ 工作正常 |
| 相似搜索 | 自研暴力搜索 | ⚠️ 小数据集可用 |

### 待优化 ⚠️
| 功能 | 当前实现 | 问题 | 建议方案 |
|-----|---------|------|---------|
| 相似搜索 | 暴力搜索 O(n) | 50k+ 预设性能下降 | hnswlib-node |
| 距离计算 | 自研 | 维护成本高 | ml-distance |
| 聚类 | 无 | 预设分组靠手动 | 后续考虑 |
| 音乐分类 | 无 | 场景识别规则-based | 后续考虑 |

## 集成计划

### Phase 1: ml-distance (立即)
**原因**: 轻量级，零配置，替换自研距离计算
**影响**: 减少 ~50 行自研代码
**风险**: 极低

### Phase 2: hnswlib-node (本周)
**原因**: 专业向量索引，性能提升 10x+
**影响**: 支持 100k+ 预设实时搜索
**风险**: 低，有回退方案

### Phase 3: 优化相似搜索 (本周)
**原因**: 整合上述库，替换自研暴力搜索
**影响**: 显著性能提升
**风险**: 中，需要测试

## 详细步骤

### Step 1: 安装依赖
```bash
npm install ml-distance hnswlib-node
```

### Step 2: 创建 HNSW 索引封装
- 封装 hnswlib-node
- 提供与现有 API 兼容的接口
- 添加特性开关

### Step 3: 替换自研相似搜索
- 保留暴力搜索作为回退
- 自动切换（<10k 暴力，>10k HNSW）

### Step 4: 使用 ml-distance
- 替换 cosineSimilarity, euclideanDistance
- 使用经过优化的专业实现

### Step 5: 测试验证
- 功能测试
- 性能测试
- 对比基准

## 预期收益

| 指标 | 当前 | 预期 | 提升 |
|-----|------|------|------|
| 相似搜索 10k | ~10ms | ~1ms | 10x |
| 相似搜索 100k | ~500ms | ~5ms | 100x |
| 代码维护 | 高 | 低 | 减少自研 |
| 可靠性 | 中 | 高 | 专业库 |

## 回滚策略
- 特性开关控制
- 保留自研实现作为回退
- 可随时切换
