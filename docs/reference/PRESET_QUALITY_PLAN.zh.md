# 预设库“邪恶问题”本地计划（质量检测 + 预加载缓冲 + 扫描治理）

> 目标：扫描更大的预设库；优化网页切换预设时的卡顿/黑屏；对坏预设做“修复/降级/删除”；收藏到本地的预设必须可靠（不过亮/不过暗/不卡死/不黑屏）。

## 0. 约定与原则

- **线上优先**：运行时优先保证“可演出”，宁可跳过/拉黑坏预设，也不要卡住。
- **渐进治理**：先做可观测与自动规避（黑屏/卡住/极端亮度），再做修复策略（参数纠偏、替换、下架）。
- **同一套规则复用**：运行时 Random/切换 + 后台预加载 + 离线扫描脚本要尽量复用同一个“质量标准”。

## 1. 问题清单（逐条解决）

### 1.1 黑屏/无画面

- 现象：切换后画面全黑或几乎全黑；或渲染失败导致纹理不更新。
- 可能原因：
  - preset 本身输出极暗；
  - ProjectM render 返回 false；
  - WASM abort / engine 崩溃；
  - 资源加载失败（纹理/采样器）。
- 解决策略（先规避）：
  - 基于 **avgLuma** 低阈值判定过暗，自动 reroll 或标记坏预设；
  - render 失败 / abort 直接标记为坏预设并进入黑名单。

### 1.2 过亮/刺眼

- 现象：avgLuma 长时间过高；舞台上刺眼。
- 解决策略：
  - 质量判定：avgLuma 超阈值持续 N 次采样 → reroll；
  - 治理：为该 preset 记录“纠偏参数”（例如外部 opacity bias / audioReactiveMultiplier），优先自动调低。

### 1.3 卡住不会动（低运动/冻结）

- 现象：画面不变化，像静态图；或帧数不增长。
- 解决策略：
  - 质量判定：
    - framesRendered 长时间不变；或
    - avgLuma/avgColor 变化量持续小于阈值 → freeze。
  - 规避：自动 reroll + 标记为坏预设（带原因：no-frames/low-motion）。

### 1.4 切换卡顿（主线程阻塞/黑屏窗口期）

- 现象：点击下一首/随机时卡顿，甚至黑屏几秒。
- 解决策略：
  - **预加载缓冲计划**：每次 Random 成功后，在后台“预载入几个候选预设 + 参数变体”，提前把文本/资源放进缓存，并快速跑一轮质量探测。
  - 限制并发与退避：不抢占当前切换；忙时不跑；失败后指数退避。

## 2. 质量标准（建议阈值）

- avgLuma：
  - 过暗：$\text{avgLuma} \le 0.06$ 持续 $> 2\,s$
  - 过亮：$\text{avgLuma} \ge 0.96$ 持续 $> 2\,s$
- freeze：
  - framesRendered 在 $> 2.2\,s$ 内不变化；或
  - avgColor/avgLuma 的变化量持续低于阈值 $> 2.5\,s$

> 注：阈值必须可配置，并且运行时和离线扫描尽量共享。

## 3. 预加载缓冲计划（运行时）

- 触发：每次 Random 成功切换后。
- 行为：
  - 从随机池抽取 K 个候选（避开最近随机、软黑名单、美学黑名单、质量黑名单）。
  - 对每个候选：
    - 预取 preset 文本（命中 presetPrefetchCache）；
    - 低分辨率快速探测（N 帧）得到质量 verdict。
  - 若 verdict 为坏：写入质量黑名单（可带 TTL）。

## 4. 收藏（必须包含“所有参数”）

- 收藏保存的内容至少包括：
  - VisualStateV2（含 FG/BG presetId/presetUrl、blend、宏、背景层参数等）
  - ProjectM 每层的“行为参数”（例如 audioReactiveMultiplier / externalOpacityBiasSigned）
- 加载收藏时：先恢复 state，再恢复 tuning（FG + BG 分别恢复）。

## 5. 离线扫描（脚本）

- 扫描更大的库时输出：
  - library-manifest.json（v0）
  - quality-report.json（每个 preset 的探测结果、原因、建议处理）
- 同一套规则：文件名卫生/去重 + 质量探测（可选 headless 浏览器跑 WASM 探测）。

## 6. 验证清单

- Random 连点不应造成卡死。
- 黑屏/过亮/冻结预设应被自动 reroll，并进入黑名单。
- 收藏后立即加载应还原相同视觉（含 FG/BG 行为参数）。
- verify:check 通过。
