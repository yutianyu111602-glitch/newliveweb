## 0) 文档头
- 标题：newliveweb 近期3周交付计划（不打断 aidata 训练）
- 版本：v3
- 日期：2026-02-15
- 执行前置（工作目录、Node/npm/Git 假设、训练保护规则）
  - 工作目录：`cd newliveweb`
  - Node：`node -v` >= 20.11.0
  - npm：`npm -v` >= 10.0.0
  - Git：本计划 **不使用 git**（不提交、不回滚、不打 tag；回滚只使用 snapshots/patch）
  - 训练保护规则（全周期强制）
    - 仅允许只读：`../aidata/AGENTS.md`、`../aidata/AI_TEAM_PLAN_OPTIMIZATION.md`、`../aidata/AIVJ_AUTO_TRAINING/training_status.json`
    - 禁止：大规模递归扫描 `../aidata`、重度 tail 训练日志、遍历 checkpoint/output

## 门禁矩阵（真相源定义，Release 只依赖 verify:check）

- Dev 回归门禁：`npm run verify:dev`
  - 责任：生成/刷新 `artifacts/headless/report.json` 与 headless 日志
- Release 硬门禁（唯一发布阻断）：`npm run verify:check`
  - 责任：校验 `report.json` 最小字段/一致性/错误日志；失败即阻断发布
- `npm run lint` 触发时机：涉及 TypeScript/接口变更、模块拆分（P0-03/P1-06/P1-08）后必须跑
- `npm run build` 触发时机：涉及工具链/tsconfig（P0-05）后必须跑

> 说明：任何“发布/Release”流程只依赖 `npm run verify:check` 的退出码（0=通过，非0=阻断）。

## 1) 3周目标与量化指标（含字段名映射策略）

### 1.1 指标定义（发布口径）
- A：帧时间 p95（`p95_frame_ms`）
- B：抖动 p95（`jitter_p95_ms`）
- C：错误率（`error_rate`=page error + console error）
- D：`verify:check` 连续通过次数（`verify_check_streak`）
- E：关键场景稳定性（S1/S2/S3）

### 1.2 基线获取、目标阈值、验收命令
- A/B
  - 基线：执行 `verify:dev` 5 次取中位数
  - 目标：`p95_frame_ms` 下降 >=20%；`jitter_p95_ms` 下降 >=25%
  - 验收命令（PowerShell）：
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/metrics/sample-baseline.ps1 -Runs 5 -Report artifacts/headless/report.json -Out artifacts/headless/baseline-summary.json`
  - 验收命令（bash）：
    - `bash scripts/metrics/sample-baseline.sh 5 artifacts/headless/report.json artifacts/headless/baseline-summary.json`
- C
  - 基线：统计 `artifacts/headless/page-errors.log` 非空行与 `artifacts/headless/browser-console.log` ERROR 行
  - 目标：page-errors=0；console ERROR 较基线下降 >=20%
  - 验收命令：`npm run verify:dev`
- D
  - 基线：连续 3 次 `verify:check`
  - 目标：连续 10 次通过
  - 验收命令（cmd）：`for /l %i in (1,1,10) do npm run verify:check`
  - 验收命令（PowerShell）：`1..10 | % { npm run verify:check; if($LASTEXITCODE -ne 0){exit 1} }`
- E
  - 基线：S1/S2/S3 各执行 1 次
  - 目标：S1>=99.5%；S2=100%；S3 page-errors=0 且 jitter 达 B 阈值
  - 验收命令：`node scripts/scenarios/run-s1.mjs; node scripts/scenarios/run-s2.mjs; node scripts/scenarios/run-s3.mjs; npm run verify:check`

### 1.3 report.json 字段映射表
| 规范指标 | 候选键优先级 | 取值策略 |
|---|---|---|
| p95_frame_ms | frameTimeP95Ms -> perf.frame.p95 -> metrics.frame.p95 -> frame.p95Ms | 取首个存在且为 number |
| jitter_p95_ms | frameTimeJitterP95Ms -> perf.jitter.p95 -> metrics.jitter.p95 -> jitter.p95Ms | 取首个存在且为 number |
| error_rate.console | errors.console.count -> consoleErrors | 不存在时回退日志统计 |
| error_rate.page | errors.page.count -> pageErrors | 不存在时回退日志统计 |
| verify_check_streak | verify.check.streak -> checks.verifyCheckStreak | 不存在时外部循环计数 |
| scenario_s1_pass_rate | scenarios.S1.passRate -> scenario.s1.passRate | 百分比 |
| scenario_s2_pass_rate | scenarios.S2.passRate -> scenario.s2.passRate | 百分比 |
| scenario_s3_pass_rate | scenarios.S3.passRate -> scenario.s3.passRate | 百分比 |

### 1.4 report.json 键探测脚本（PowerShell + bash）
- PowerShell：
  - `powershell -NoProfile -Command "node -e \"const fs=require('fs');const p='artifacts/headless/report.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));const out=[];const walk=(o,p='')=>{if(o&&typeof o==='object'){for(const k of Object.keys(o)){const n=p?`${p}.${k}`:k;out.push(n);walk(o[k],n)}}};walk(j);console.log(out.sort().join('\\n'));\""`
- bash：
  - `node -e "const fs=require('fs');const p='artifacts/headless/report.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));const out=[];const walk=(o,p='')=>{if(o&&typeof o==='object'){for(const k of Object.keys(o)){const n=p?`${p}.${k}`:k;out.push(n);walk(o[k],n)}}};walk(j);console.log(out.sort().join('\\n'));"`

### 1.5 采样脚本（verify:dev 跑5次取中位数）
- PowerShell：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/metrics/sample-baseline.ps1 -Runs 5 -Report artifacts/headless/report.json -Out artifacts/headless/baseline-summary.json`
- bash：`bash scripts/metrics/sample-baseline.sh 5 artifacts/headless/report.json artifacts/headless/baseline-summary.json`

### 1.6 字段映射落地文件（强制）

- 真相源文件：`scripts/metrics/report-field-priority.json`
- 维护方式：任何新增/变更 report.json 指标键时，先运行 1.4 的 key 探测脚本，再将新键路径按优先级追加到 `report-field-priority.json` 对应数组末尾
- P0-00 门禁：`scripts/metrics/map-report-fields.mjs` 必须读取该文件，输出最终命中的键路径

## 2) WBS（P0/P1/P2）

## 回滚规范（不依赖 git，强制执行）

### 快照目录命名规则（每个任务必须执行）

- 快照根目录：`artifacts/snapshots/<TaskID>/<YYYY-MM-DD_HHMM>/`
- PowerShell 时间戳：`$TS = Get-Date -Format 'yyyy-MM-dd_HHmm'`
- bash 时间戳：`TS=$(date +%F_%H%M)`

### 快照必须包含的内容（每次至少包含）

1. `files.txt`：本任务允许修改的文件相对路径清单
2. `manifest.json`：快照元数据（TaskID、时间戳、执行人本机用户名、门禁结果）
3. 关键产物基线（存在即复制，不存在则写 `MISSING` 标记文件）
   - `artifacts/headless/report.json`
   - `artifacts/headless/browser-console.log`
   - `artifacts/headless/page-errors.log`
   - `logs/aivj-selection.log`
4. 哈希/摘要输出
   - `hash-report-subset.json`（来自 `scripts/metrics/hash-report-subset.mjs`）
   - `baseline-summary.json`（来自采样脚本）

### 回滚方式（两条都可复制执行）

#### 方式1：restore from snapshots（默认回滚方式）

- PowerShell（以 P0-03 为例，恢复 files.txt 中列出的文件 + 关键产物）：
  - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-03/2026-02-15_2359`

#### 方式2：apply reverse patch（仅用于文本文件；二选一与方式1并存）

- bash（以 P0-03 为例，生成 reverse patch 并应用）：
  - 生成：`bash scripts/rollback/make-reverse-patch.sh artifacts/snapshots/P0-03/2026-02-15_2359 artifacts/rollback/P0-03_reverse.patch`
  - 应用：`bash scripts/rollback/apply-patch.sh artifacts/rollback/P0-03_reverse.patch`

> P0-00 必须落地 `scripts/rollback/*` 的最小骨架脚本，确保上述命令可运行。

### P0-00 全局验收脚手架（blocking）
- 目的：先落地 metrics/ci/scenarios 最小可运行骨架，保证后续所有验收命令可执行
- 修改范围：
  - `scripts/metrics/map-report-fields.mjs`
  - `scripts/metrics/sample-baseline.ps1`
  - `scripts/metrics/sample-baseline.sh`
  - `scripts/metrics/hash-report-subset.mjs`
  - `scripts/metrics/hash-dist-structure.mjs`
  - `scripts/metrics/compare-baseline.mjs`
  - `scripts/ci/validate-artifact-schema.mjs`
  - `scripts/ci/doc-gate-consistency.mjs`
  - `scripts/ci/compare-selection-log.mjs`
  - `scripts/ci/runbook-smoke.mjs`
  - `scripts/scenarios/run-s1.mjs`
  - `scripts/scenarios/run-s2.mjs`
  - `scripts/scenarios/run-s3.mjs`
  - `scripts/scenarios/snapshot-points.mjs`
  - `scripts/verify-dev.mjs`（接入点：--scenarios）
  - `scripts/verify-check.mjs`（接入点：schema 校验）
  - `scripts/rollback/restore-from-snapshot.ps1`
  - `scripts/rollback/make-reverse-patch.sh`
  - `scripts/rollback/apply-patch.sh`
  - `scripts/metrics/report-field-priority.json`（字段优先级真相源）
- 具体改动清单（diff要点）
  - 新增脚本最小骨架：参数解析、文件存在检查、返回码 0/1
  - 为 `verify:dev` 增加 `--scenarios` 可选入口
  - 为 `verify:check` 增加 schema 校验入口
  - 为回滚新增 3 个脚本入口：restore/patch
- 细化步骤
  - 本地分支名：`release/w1d1-p0-00-scaffold`（仅本地，不推送）
  - 本地记录标识（可选）：`P0-00 scaffold metrics/ci/scenarios/rollback minimal runnable scripts`
  - 本地里程碑标识（可选）：`planv3/p0-00`
- 工期：1.5天 / 12小时
- 依赖：无
- 阻塞：blocking
- 行为不变证明点：
  - 业务逻辑不改；P0-00 只新增脚本与可选入口，不改变默认 verify 主路径
  - 对比 `artifacts/headless/report.json` 关键字段 hash（P0-00 完成前后）
- 门禁触发时机：`npm run verify:dev`、`npm run verify:check`
- 验收标准：全部新增脚本命令可执行并返回预期退出码
- 验收失败分流处置：
  1) 止损：仅保留独立入口，不接入主门禁
  2) 定位：逐脚本 `node script --help` 检查参数
  3) 回滚：restore from snapshots（按本节回滚规范执行）
- 回滚步骤（无 git）：
  - 快照目录：`artifacts/snapshots/P0-00/<TS>/`
  - 创建快照（PowerShell）：
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-00 -Timestamp $TS -Files scripts/metrics/report-field-priority.json scripts/verify-dev.mjs scripts/verify-check.mjs`
  - 回滚：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-00/$TS`

#### P0-00 脚本契约（最小可跑/可验收）

> 所有脚本必须遵守：不得读取/遍历 `../aidata` 除白名单 3 个小文件以外任何内容。

- `scripts/metrics/map-report-fields.mjs`
  - 输入：`artifacts/headless/report.json`、`scripts/metrics/report-field-priority.json`
  - 输出：`artifacts/headless/report-field-map.json`
  - 输出最小字段：`{ version, selected: { p95_frame_ms: {path,value}, jitter_p95_ms:{path,value} }, missing: string[] }`
  - exit code：0=映射成功（即使部分 missing），1=report.json 不可读/不是 JSON
- `scripts/metrics/sample-baseline.ps1`
  - 输入：`-Runs 5`，每轮执行 `npm run verify:dev`，读取 `artifacts/headless/report.json`
  - 输出：`artifacts/headless/baseline-summary.json`
  - 输出最小字段：`{ runs:number, values:{p95_frame_ms:number[], jitter_p95_ms:number[]}, median:{p95_frame_ms:number, jitter_p95_ms:number} }`
  - exit code：0=成功生成，1=任一轮 verify:dev 失败或 report.json 缺关键字段
- `scripts/metrics/sample-baseline.sh`
  - 契约同上（bash 版）
- `scripts/ci/validate-artifact-schema.mjs`
  - 输入：`artifacts/headless/report.json`
  - 输出：stdout 打印校验结果 JSON（并写 `artifacts/headless/schema-check.json`）
  - 规则：P2-11 前 `schemaVersion` 缺失输出 warning；P2-11 后缺失视为 fail
  - exit code：0=通过（含 warning），1=失败
- `scripts/scenarios/run-s1.mjs`
  - 输入：可选 `--iterations 200`
  - 输出：`artifacts/headless/scenario-s1.json`
  - 输出最小字段：`{ scenario:'S1', iterations:number, passRate:number, failures:number, reasonsTop:string[] }`
  - exit code：0=生成成功；1=执行中断
- `scripts/scenarios/run-s2.mjs`
  - 输入：可选 `--iterations 100`
  - 输出：`artifacts/headless/scenario-s2.json`（字段同 S2）
- `scripts/scenarios/run-s3.mjs`
  - 输入：可选 `--seconds 600`
  - 输出：`artifacts/headless/scenario-s3.json`
  - 输出最小字段：`{ scenario:'S3', seconds:number, pageErrors:number, consoleErrors:number, jitter_p95_ms:number|null, notes:string[] }`
- `scripts/metrics/hash-report-subset.mjs`
  - 输入：`artifacts/headless/report.json`
  - 输出：stdout 打印稳定 hash，并写 `artifacts/headless/hash-report-subset.json`
  - 稳定性要求：固定 key 排序 + 稳定 stringify
- `scripts/metrics/hash-dist-structure.mjs`
  - 输入：`dist/`
  - 输出：`artifacts/headless/hash-dist-structure.json`
  - 规则：只 hash 路径 + 文件大小，不读取大文件内容

#### P0-00 安全检测（强制）

- PowerShell（仅扫描门禁脚本：`scripts/metrics|ci|scenarios|rollback` + `scripts/verify-*.mjs`，不扫描 `scripts/aivj` 与训练 batch）：
  - `powershell -NoProfile -Command "$targets=@('scripts/metrics','scripts/ci','scripts/scenarios','scripts/rollback','scripts/verify-dev.mjs','scripts/verify-check.mjs','scripts/headless-verify.mjs','scripts/guardrails-check.mjs'); $files=foreach($t in $targets){if(Test-Path $t){if((Get-Item $t).PSIsContainer){Get-ChildItem $t -Recurse -File}else{Get-Item $t}}}; $hits=$files|Select-String -Pattern '(?i)(\\.\\./aidata|/aidata|D:\\\\aidata)' -AllMatches -ErrorAction SilentlyContinue; if($hits){$hits|Select-Object -First 50|Format-List Path,LineNumber,Line; exit 1}else{'OK'; exit 0}"`
- bash（同上，仅扫描门禁脚本目录/文件）：
  - `grep -R -n -E "../aidata|/aidata|D:\\\\aidata" scripts/metrics scripts/ci scripts/scenarios scripts/rollback scripts/verify-dev.mjs scripts/verify-check.mjs scripts/headless-verify.mjs scripts/guardrails-check.mjs && exit 1 || exit 0`

### P0-01 门禁真相源统一（blocking）
- 目的：发布硬门禁唯一化为 `verify:check`
- 修改范围：`package.json`、`scripts/verify-check.mjs`、`scripts/verify-dev.mjs`、`DOCS_INDEX.zh.md`、`TODOS.zh.md`
- 具体改动清单：统一脚本语义、统一退出码、文档门禁矩阵
- 细化步骤：分支 `release/w1d2-p0-01-gate`；commit `P0-01 unify release gate to verify-check`; tag `planv3/p0-01`
- 工期：0.75天 / 6小时
- 依赖：P0-00
- 阻塞：blocking
- 行为不变证明点：对比 report key hash、page-errors 行数、console ERROR 行数
- 门禁触发时机：`npm run verify:dev && npm run verify:check`
- 验收标准：`verify:check` exit 0；文档无第二发布门禁定义
- 验收失败分流处置：止损冻结合并 -> 定位脚本映射 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-01 -Timestamp $TS -Files package.json scripts/verify-check.mjs scripts/verify-dev.mjs DOCS_INDEX.zh.md TODOS.zh.md`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-01/$TS`
  - reverse patch（bash）：`bash scripts/rollback/make-reverse-patch.sh artifacts/snapshots/P0-01/$TS artifacts/rollback/P0-01_reverse.patch; bash scripts/rollback/apply-patch.sh artifacts/rollback/P0-01_reverse.patch`

### P0-02 文档状态对齐（non-blocking）
- 目的：建立单一状态真相源
- 修改范围：`MASTER_SPEC.zh.md`、`TODOS.zh.md`、`docs/PROJECT_STATUS_AI.md`、`docs/OPTIMIZATION_PLAN.zh.md`
- 具体改动清单：标注 canonical/historical；统一任务状态
- 细化步骤：分支 `release/w1d2-p0-02-doc-sync`; commit `P0-02 align status docs`; tag `planv3/p0-02`
- 工期：0.5天 / 4小时
- 依赖：P0-01
- 阻塞：non-blocking
- 行为不变证明点：本任务快照目录下 `files.txt` 仅包含文档路径（`artifacts/snapshots/P0-02/<TS>/files.txt`）
- 门禁触发时机：`npm run verify:check`
- 验收标准：check 通过，状态冲突清零
- 验收失败分流处置：止损撤文档改动 -> 定位冲突任务ID -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-02 -Timestamp $TS -Files MASTER_SPEC.zh.md TODOS.zh.md docs/PROJECT_STATUS_AI.md docs/OPTIMIZATION_PLAN.zh.md`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-02/$TS`

### P0-03 bootstrap 第一刀拆分（blocking）
- 目的：拆分编排层并保持外部行为不变
- 修改范围：`src/app/bootstrap.ts`、`src/app/bootstrap/index.ts`、`src/main.ts`
- 具体改动清单：提取 startup/runtime/preset-flow/verify-hooks
- 细化步骤：分支 `release/w1d3-4-p0-03-bootstrap`; commit `P0-03 extract bootstrap phase modules`; tag `planv3/p0-03`
- 工期：2天 / 14小时
- 依赖：P0-01
- 阻塞：blocking
- 行为不变证明点：
  - `artifacts/headless/report.json` 关键字段 hash
  - `logs/aivj-selection.log` 决策字段一致
  - `scripts/scenarios/snapshot-points.mjs` 截图点 hash 一致
- 门禁触发时机：`npm run verify:dev && npm run verify:check && npm run lint`
- 验收标准：check 通过；page-errors=0；截图点 hash 一致
- 验收失败分流处置：止损关新接线 -> 定位初始化顺序 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-03 -Timestamp $TS -Files src/app/bootstrap.ts src/app/bootstrap/index.ts src/main.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-03/$TS`
  - reverse patch（bash）：`bash scripts/rollback/make-reverse-patch.sh artifacts/snapshots/P0-03/$TS artifacts/rollback/P0-03_reverse.patch; bash scripts/rollback/apply-patch.sh artifacts/rollback/P0-03_reverse.patch`

### P0-04 ProjectM 生产路径定责（blocking）
- 目的：生产路径唯一，V2/V3 实验化
- 修改范围：`src/projectm/ProjectMEngine.ts`、`src/projectm/ProjectMEngineV2.ts`、`src/projectm/ProjectMEngineV3.ts`、`src/layers/ProjectMLayer.ts`、`src/config/featureFlags.ts`
- 具体改动清单：固定 prod 引擎，实验 flag 默认 false，日志标识
- 细化步骤：分支 `release/w1d5-p0-04-projectm`; commit `P0-04 set single ProjectM production path`; tag `planv3/p0-04`
- 工期：0.75天 / 6小时
- 依赖：P0-03
- 阻塞：blocking
- 行为不变证明点：browser-console 中仅 prod 引擎标识
- 门禁触发时机：`npm run verify:dev && npm run verify:check`
- 验收标准：`engine=prod` 出现；`engine=exp` 不出现；check 通过
- 验收失败分流处置：止损关实验 flag -> 定位导入链 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-04 -Timestamp $TS -Files src/projectm/ProjectMEngine.ts src/projectm/ProjectMEngineV2.ts src/projectm/ProjectMEngineV3.ts src/layers/ProjectMLayer.ts src/config/featureFlags.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-04/$TS`

### P0-05 TS 前向兼容修复（non-blocking）
- 目的：消除工具链迁移阻断
- 修改范围：`tsconfig.json`
- 具体改动清单：清理弃用项，保持输出结构
- 细化步骤：分支 `release/w2d1-p0-05-ts`; commit `P0-05 tsconfig forward compat`; tag `planv3/p0-05`
- 工期：0.5天 / 3小时
- 依赖：无
- 阻塞：non-blocking
- 行为不变证明点：`scripts/metrics/hash-dist-structure.mjs` 比对一致
- 门禁触发时机：`npm run lint && npm run build && npm run verify:check`
- 验收标准：lint/build/check 全通过
- 验收失败分流处置：止损锁版本 -> 定位最小 diff -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-05 -Timestamp $TS -Files tsconfig.json`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-05/$TS`

### P1-06 观测口径统一（blocking）
- 目的：单一 metrics schema
- 修改范围：`src/performance/PerformanceBudgetManager.ts`、`src/utils/performanceMonitor.ts`、`src/app/diagnostics/perfCollector.ts`、`src/features/console/DiagnosticsPanel.ts`
- 具体改动清单：统一 schema、双写兼容、面板对齐
- 细化步骤：分支 `release/w2d2-3-p1-06-metrics`; commit `P1-06 unify metrics schema`; tag `planv3/p1-06`
- 工期：1.5天 / 10小时
- 依赖：P0-03
- 阻塞：blocking
- 行为不变证明点：渲染截图 hash 不变；仅指标字段变化
- 门禁触发时机：`npm run verify:dev && npm run verify:check`
- 验收标准：映射脚本成功；schema 校验通过
- 验收失败分流处置：止损启双读 -> 定位字段映射 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P1-06 -Timestamp $TS -Files src/performance/PerformanceBudgetManager.ts src/utils/performanceMonitor.ts src/app/diagnostics/perfCollector.ts src/features/console/DiagnosticsPanel.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-06/$TS`

### P1-07 预设优先级规则固定（blocking）
- 目的：同输入同输出
- 修改范围：`src/features/presets/PresetsController.ts`、`src/features/presets/runManifestStore.ts`、`src/features/presets/coupledPairsLoader.ts`、`src/config/presetLibraries.ts`
- 具体改动清单：固定优先级链；统一决策日志
- 细化步骤：分支 `release/w2d4-p1-07-precedence`; commit `P1-07 deterministic preset precedence`; tag `planv3/p1-07`
- 工期：1天 / 8小时
- 依赖：P0-03
- 阻塞：blocking
- 行为不变证明点：`scripts/ci/compare-selection-log.mjs` 同输入 hash 一致
- 门禁触发时机：`npm run verify:dev && npm run verify:check`
- 验收标准：check 通过；决策一致
- 验收失败分流处置：止损切 legacy resolver -> 定位顺序 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P1-07 -Timestamp $TS -Files src/features/presets/PresetsController.ts src/features/presets/runManifestStore.ts src/features/presets/coupledPairsLoader.ts src/config/presetLibraries.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-07/$TS`

### P1-08 预设切换稳态加固（blocking）
- 目的：降低切换/重建抖动
- 修改范围：`src/SceneManager.ts`、`src/layers/LiquidMetalLayerV2.ts`、`src/state/paramSchema.ts`
- 具体改动清单：显式状态机、去抖、恢复边界
- 细化步骤：分支 `release/w2d5-p1-08-switch`; commit `P1-08 harden switch state machine`; tag `planv3/p1-08`
- 工期：1.5天 / 11小时
- 依赖：P1-07
- 阻塞：blocking
- 行为不变证明点：S1/S2 截图点 hash 一致且通过率达标
- 门禁触发时机：`npm run verify:dev && npm run verify:check && npm run lint`
- 验收标准：S1>=99.5%；S2=100%；check 通过
- 验收失败分流处置：止损关新状态机 -> 定位参数 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P1-08 -Timestamp $TS -Files src/SceneManager.ts src/layers/LiquidMetalLayerV2.ts src/state/paramSchema.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-08/$TS`

### P1-09 音频背压稳态优化（blocking）
- 目的：高负载音频下保持帧稳态
- 修改范围：`src/audio/AudioBus.ts`、`src/audio/StreamAudioProcessor.ts`、`src/audio/AudioController.ts`、`src/config/featureFlags.ts`
- 具体改动清单：背压阈值、限流、指标上报
- 细化步骤：分支 `release/w3d1-p1-09-audio`; commit `P1-09 stabilize audio backpressure`; tag `planv3/p1-09`
- 工期：1天 / 8小时
- 依赖：P1-06
- 阻塞：blocking
- 行为不变证明点：业务路径不变；仅稳态参数与指标增强
- 门禁触发时机：`npm run verify:dev && npm run verify:check`
- 验收标准：S3 page-errors=0；jitter 达标
- 验收失败分流处置：止损切 legacy 背压 -> 定位缓冲窗口 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P1-09 -Timestamp $TS -Files src/audio/AudioBus.ts src/audio/StreamAudioProcessor.ts src/audio/AudioController.ts src/config/featureFlags.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-09/$TS`

### P2-10 bootstrap 第二刀拆分（non-blocking）
- 目的：继续降复杂度
- 修改范围：`src/app/bootstrap.ts`、`src/app/bootstrap/index.ts`
- 具体改动清单：迁移剩余逻辑，清理死路径
- 细化步骤：分支 `release/w3d2-p2-10-bootstrap`; commit `P2-10 bootstrap modularization phase2`; tag `planv3/p2-10`
- 工期：1天 / 7小时
- 依赖：P0-03
- 阻塞：non-blocking
- 行为不变证明点：report key hash + 截图点 hash 一致
- 门禁触发时机：`npm run verify:check`
- 验收标准：check 连续 3 次通过
- 验收失败分流处置：止损恢复旧导出 -> 定位引用链 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P2-10 -Timestamp $TS -Files src/app/bootstrap.ts src/app/bootstrap/index.ts`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P2-10/$TS`

### P2-11 工件 schema 版本化（non-blocking）
- 目的：产物可验证可演进
- 修改范围：`scripts/verify-check.mjs`、`scripts/preset-audit.mjs`、`artifacts/headless/report.json`
- 具体改动清单：新增 schemaVersion 与兼容分支
- 细化步骤：分支 `release/w3d3-p2-11-schema`; commit `P2-11 artifact schema versioning`; tag `planv3/p2-11`
- 工期：0.75天 / 6小时
- 依赖：P1-06
- 阻塞：non-blocking
- 行为不变证明点：业务输出不变，仅产物元数据扩展
- 门禁触发时机：`npm run verify:dev && npm run verify:check`
- 验收标准：schema 校验通过，version 存在
- 验收失败分流处置：止损启旧 schema 读路径 -> 定位版本分支 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P2-11 -Timestamp $TS -Files scripts/verify-check.mjs scripts/preset-audit.mjs`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P2-11/$TS`

### P2-12 运行手册最小化（non-blocking）
- 目的：执行一致性
- 修改范围：`LOCAL_DEV_GUIDE.md`、`DOCS_INDEX.zh.md`
- 具体改动清单：固化改动后/发布前/失败回滚命令序列
- 细化步骤：分支 `release/w3d4-p2-12-runbook`; commit `P2-12 finalize minimal runbook`; tag `planv3/p2-12`
- 工期：0.5天 / 4小时
- 依赖：P0-01
- 阻塞：non-blocking
- 行为不变证明点：文档改动不影响代码行为
- 门禁触发时机：`npm run verify:check`
- 验收标准：手册命令可执行，check 通过
- 验收失败分流处置：止损撤手册改动 -> 定位命令偏差 -> 执行“回滚步骤（无 git）”
- 回滚步骤（无 git）：
  - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P2-12 -Timestamp $TS -Files LOCAL_DEV_GUIDE.md DOCS_INDEX.zh.md`
  - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P2-12/$TS`

## 3) Day1~Day15 逐日排期（含PR拆分、门禁、回滚）
- PR 标题格式：`[W{N}D{N}] {TaskID} - {Title}`
- Day1（W1D1）：P0-00（metrics/ci/rollback 骨架）
  - 当天目标：落地 metrics/ci/rollback 脚本骨架并可执行；不接入主门禁默认路径
  - 改动文件（限定）：`scripts/metrics/*`、`scripts/ci/*`、`scripts/rollback/*`、`scripts/metrics/report-field-priority.json`
  - 本地 PR 拆分（仅本地分支/不推送）
    - `[W1D1] P0-00 - Scaffold metrics and ci scripts`
    - `[W1D1] P0-00 - Scaffold snapshot rollback scripts`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
  - 当天回滚剧本（无 git）
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId P0-00 -Timestamp $TS -Files scripts/metrics/report-field-priority.json`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-00/$TS`

- Day2（W1D2）：P0-00（scenarios 接入）+ P0-01（门禁真相源）
  - 当天目标：S1/S2/S3 stub 可生成 JSON；`verify:dev --scenarios` 可汇总；`verify:check` 加入 schema 校验入口
  - 改动文件（限定）：`scripts/scenarios/*`、`scripts/verify-dev.mjs`、`scripts/verify-check.mjs`、`package.json`、`DOCS_INDEX.zh.md`
  - 本地 PR 拆分
    - `[W1D2] P0-00 - Scaffold scenario scripts and hook verify-dev --scenarios`
    - `[W1D2] P0-01 - Unify release gate semantics (verify:check only)`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
    - `node scripts/scenarios/run-s1.mjs; node scripts/scenarios/run-s2.mjs; node scripts/scenarios/run-s3.mjs`
  - 当天回滚剧本
    - 创建快照：`$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W1D2 -Timestamp $TS -Files scripts/scenarios/run-s1.mjs scripts/scenarios/run-s2.mjs scripts/scenarios/run-s3.mjs scripts/verify-dev.mjs scripts/verify-check.mjs package.json DOCS_INDEX.zh.md`
    - restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W1D2/$TS`

- Day3（W1D3）：P0-02（文档状态对齐）+ P0-03（bootstrap 拆分启动段）
  - 当天目标：文档状态冲突清零；bootstrap 提取 startup/runtime 段，不改变外部行为
  - 改动文件（限定）：`MASTER_SPEC.zh.md`、`TODOS.zh.md`、`docs/PROJECT_STATUS_AI.md`、`src/app/bootstrap.ts`、`src/app/bootstrap/index.ts`
  - 本地 PR 拆分
    - `[W1D3] P0-02 - Align canonical status docs`
    - `[W1D3] P0-03 - Extract startup/runtime phases (no behavior change)`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W1D3 -Timestamp $TS -Files MASTER_SPEC.zh.md TODOS.zh.md docs/PROJECT_STATUS_AI.md src/app/bootstrap.ts src/app/bootstrap/index.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W1D3/$TS`

- Day4（W1D4）：P0-03（bootstrap 拆分 preset/verify hooks）
  - 当天目标：完成第一刀拆分；截图点 hash 与 report subset hash 与基线一致
  - 改动文件（限定）：`src/app/bootstrap.ts`、`src/main.ts`、`scripts/scenarios/snapshot-points.mjs`
  - 本地 PR 拆分
    - `[W1D4] P0-03 - Extract preset flow and verify hooks (no behavior change)`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
    - `node scripts/scenarios/snapshot-points.mjs`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W1D4 -Timestamp $TS -Files src/app/bootstrap.ts src/main.ts scripts/scenarios/snapshot-points.mjs`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W1D4/$TS`

- Day5（W1D5）：P0-04（ProjectM 生产路径定责）
  - 当天目标：生产引擎单一路径；实验引擎默认关闭；`verify:check` 通过
  - 改动文件（限定）：`src/projectm/ProjectMEngine.ts`、`src/projectm/ProjectMEngineV2.ts`、`src/projectm/ProjectMEngineV3.ts`、`src/layers/ProjectMLayer.ts`、`src/config/featureFlags.ts`
  - 本地 PR 拆分
    - `[W1D5] P0-04 - Lock production ProjectM engine path`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W1D5 -Timestamp $TS -Files src/projectm/ProjectMEngine.ts src/projectm/ProjectMEngineV2.ts src/projectm/ProjectMEngineV3.ts src/layers/ProjectMLayer.ts src/config/featureFlags.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W1D5/$TS`

- Day6（W2D1）：P0-05（TS 前向兼容）
  - 当天目标：lint/build/check 全通过；dist 结构 hash 与基线一致
  - 改动文件（限定）：`tsconfig.json`、`scripts/metrics/hash-dist-structure.mjs`
  - 本地 PR 拆分
    - `[W2D1] P0-05 - TS config forward compatibility cleanup`
  - 当天门禁清单（必须）
    - `npm run lint`
    - `npm run build`
    - `npm run verify:check`
    - `node scripts/metrics/hash-dist-structure.mjs`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W2D1 -Timestamp $TS -Files tsconfig.json`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W2D1/$TS`

- Day7（W2D2）：P1-06（观测 schema 核心合并）
  - 当天目标：metrics schema 统一；双写兼容开启；映射文件生成
  - 改动文件（限定）：`src/performance/PerformanceBudgetManager.ts`、`src/utils/performanceMonitor.ts`、`src/app/diagnostics/perfCollector.ts`、`scripts/metrics/map-report-fields.mjs`
  - 本地 PR 拆分
    - `[W2D2] P1-06 - Unify metrics schema core (dual-write)`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `node scripts/metrics/map-report-fields.mjs artifacts/headless/report.json artifacts/headless/report-field-map.json`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W2D2 -Timestamp $TS -Files src/performance/PerformanceBudgetManager.ts src/utils/performanceMonitor.ts src/app/diagnostics/perfCollector.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W2D2/$TS`

- Day8（W2D3）：P1-06（DiagnosticsPanel 对齐）
  - 当天目标：DiagnosticsPanel 仅展示统一字段；旧字段仍双写
  - 改动文件（限定）：`src/features/console/DiagnosticsPanel.ts`
  - 本地 PR 拆分
    - `[W2D3] P1-06 - Align diagnostics panel to unified schema`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W2D3 -Timestamp $TS -Files src/features/console/DiagnosticsPanel.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W2D3/$TS`

- Day9（W2D4）：P1-07（预设优先级确定性）
  - 当天目标：同输入同输出；selection log 可复核
  - 改动文件（限定）：`src/features/presets/PresetsController.ts`、`src/features/presets/runManifestStore.ts`、`src/features/presets/coupledPairsLoader.ts`、`src/config/presetLibraries.ts`、`scripts/ci/compare-selection-log.mjs`
  - 本地 PR 拆分
    - `[W2D4] P1-07 - Enforce deterministic preset precedence`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `npm run verify:check`
    - `node scripts/ci/compare-selection-log.mjs logs/aivj-selection.log`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W2D4 -Timestamp $TS -Files src/features/presets/PresetsController.ts src/features/presets/runManifestStore.ts src/features/presets/coupledPairsLoader.ts src/config/presetLibraries.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W2D4/$TS`

- Day10（W2D5）：P1-08（预设切换稳态）
  - 当天目标：S1/S2 达标；jitter 不上升；check 通过
  - 改动文件（限定）：`src/SceneManager.ts`、`src/layers/LiquidMetalLayerV2.ts`、`src/state/paramSchema.ts`
  - 本地 PR 拆分
    - `[W2D5] P1-08 - Harden preset switch stability`
  - 当天门禁清单（必须）
    - `npm run lint`
    - `npm run verify:dev`
    - `node scripts/scenarios/run-s1.mjs; node scripts/scenarios/run-s2.mjs`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W2D5 -Timestamp $TS -Files src/SceneManager.ts src/layers/LiquidMetalLayerV2.ts src/state/paramSchema.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W2D5/$TS`

- Day11（W3D1）：P1-09（音频背压稳态）
  - 当天目标：S3 达标；page-errors=0；jitter 达 B 目标
  - 改动文件（限定）：`src/audio/AudioBus.ts`、`src/audio/StreamAudioProcessor.ts`、`src/audio/AudioController.ts`、`src/config/featureFlags.ts`
  - 本地 PR 拆分
    - `[W3D1] P1-09 - Stabilize audio backpressure`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `node scripts/scenarios/run-s3.mjs`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W3D1 -Timestamp $TS -Files src/audio/AudioBus.ts src/audio/StreamAudioProcessor.ts src/audio/AudioController.ts src/config/featureFlags.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W3D1/$TS`

- Day12（W3D2）：P2-10（bootstrap 第二刀）
  - 当天目标：第二刀拆分完成；check 连续 3 次通过
  - 改动文件（限定）：`src/app/bootstrap.ts`、`src/app/bootstrap/index.ts`
  - 本地 PR 拆分
    - `[W3D2] P2-10 - Bootstrap modularization phase2`
  - 当天门禁清单（必须）
    - `1..3 | % { npm run verify:check; if($LASTEXITCODE -ne 0){exit 1} }`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W3D2 -Timestamp $TS -Files src/app/bootstrap.ts src/app/bootstrap/index.ts`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W3D2/$TS`

- Day13（W3D3）：P2-11（schemaVersion 版本化）
  - 当天目标：schemaVersion 写入并强校验；validate-artifact-schema 规则切换为必填
  - 改动文件（限定）：`scripts/verify-check.mjs`、`scripts/preset-audit.mjs`、`scripts/ci/validate-artifact-schema.mjs`
  - 本地 PR 拆分
    - `[W3D3] P2-11 - Enforce artifact schemaVersion`
  - 当天门禁清单（必须）
    - `npm run verify:dev`
    - `node scripts/ci/validate-artifact-schema.mjs artifacts/headless/report.json`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W3D3 -Timestamp $TS -Files scripts/verify-check.mjs scripts/preset-audit.mjs scripts/ci/validate-artifact-schema.mjs`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W3D3/$TS`

- Day14（W3D4）：P2-12（运行手册 + 训练保护条款写入）
  - 当天目标：runbook-smoke 通过；DOCS_INDEX 含计划索引；训练保护规则明确写入
  - 改动文件（限定）：`LOCAL_DEV_GUIDE.md`、`DOCS_INDEX.zh.md`
  - 本地 PR 拆分
    - `[W3D4] P2-12 - Finalize minimal runbook and training safety rules`
  - 当天门禁清单（必须）
    - `node scripts/ci/runbook-smoke.mjs`
    - `npm run verify:check`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W3D4 -Timestamp $TS -Files LOCAL_DEV_GUIDE.md DOCS_INDEX.zh.md`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W3D4/$TS`

- Day15（W3D5）：Release Candidate（唯一硬门禁 + KPI 收口）
  - 当天目标：`verify:check` 连续 10 次通过；baseline-summary 输出中位数对比达到 A/B 目标
  - 改动文件（限定）：`docs/reports/PERF_OPTIMIZATION_LOG.local.md`（记录）、`TODOS.zh.md`（状态落地）
  - 本地 PR 拆分
    - `[W3D5] RC - 10x verify:check streak + KPI proof`
  - 当天门禁清单（必须）
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/metrics/sample-baseline.ps1 -Runs 5 -Report artifacts/headless/report.json -Out artifacts/headless/baseline-summary.json`
    - `1..10 | % { npm run verify:check; if($LASTEXITCODE -ne 0){exit 1} }`
  - 当天回滚剧本
    - `$TS=Get-Date -Format 'yyyy-MM-dd_HHmm'; powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/create-snapshot.ps1 -TaskId W3D5 -Timestamp $TS -Files docs/reports/PERF_OPTIMIZATION_LOG.local.md TODOS.zh.md`
    - `powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/W3D5/$TS`

## 4) 验收矩阵（Markdown表格）
| 任务 | 功能不变 | 性能 | 稳定性 | 产物一致性 | 文档一致性 | 安全 |
|---|---|---|---|---|---|---|
| P0-00 | `npm run verify:check`；脚本可运行；失败回滚 `planv3/p0-00` | `npm run verify:dev` 不退化>5% | 新脚本 exit code 可控 | `node scripts/ci/validate-artifact-schema.mjs artifacts/headless/report.json` 通过 | `node scripts/ci/doc-gate-consistency.mjs` 通过 | 禁止 `../aidata` 递归命令 |
| P0-01 | `verify:check` 通过 | `verify:dev` 无显著退化 | 连续 3 次 check 通过 | `hash-report-subset.mjs` 一致 | docs 与 package 一致 | 仅本地只读 aidata 小文件 |
| P0-02 | 文档改动不触发功能变化 | N/A | `verify:check` 通过 | N/A | 状态冲突清零 | 不触碰训练目录 |
| P0-03 | report/log/snapshot 对齐 | compare-baseline 达阈值 | S1/S2 通过率达标 | key hash 一致 | 任务状态同步 | 不打断训练 |
| P0-04 | 单一路径 prod 引擎 | verify:dev 无显著退化 | verify:check 通过 | report 一致 | 文档唯一声明 | 实验 flag 默认 false |
| P0-05 | build 通过 | verify:dev 无退化 | lint/check 通过 | dist 结构 hash 一致 | 文档同步 | 无外部 I/O 增量 |
| P1-06 | 功能输出不变 | 字段映射成功 | check 通过 | schema 校验通过 | 指标口径一致 | 仅本地处理 |
| P1-07 | 同输入同输出 | 切换耗时不退化>10% | check 通过 | selection log 一致 | 规则文档一致 | AI/coupled 实验态 |
| P1-08 | 视觉行为一致 | jitter 达标 | S1/S2 达标 | 报告字段完整 | 文档一致 | 无训练干扰 |
| P1-09 | 音频路径可用 | S3 达标 | check 通过 | 音频字段存在 | 文档一致 | legacy 开关可降级 |
| P2-10 | 功能一致 | 无退化 | check 3连过 | key hash 一致 | 文档一致 | 安全合规 |
| P2-11 | 功能一致 | 解析时延可控 | check 通过 | schemaVersion 存在 | 文档一致 | 安全合规 |
| P2-12 | 功能一致 | 回归时长可控 | runbook-smoke 通过 | 产物路径文档一致 | 文档与脚本一致 | 训练保护规则写入手册 |

## 5) 风险清单与预案（Markdown表格）
| 风险 | 检测方式 | 触发阈值 | 第一时间止损动作 | 降级/回滚开关 | 负责人 |
|---|---|---|---|---|---|
| bootstrap 隐式耦合回归 | `verify:dev` + S1/S2 + snapshot hash | page-errors>0 或 check 连续2次失败 | 冻结合并，关闭新接线 | restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-03/<YYYY-MM-DD_HHMM>` | Tech Lead |
| 预设优先级行为改变 | compare-selection-log | 同输入不一致>=1次 | 切 legacy resolver | restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-07/<YYYY-MM-DD_HHMM>` | Preset Owner |
| 观测口径字段漂移 | validate-artifact-schema | 缺关键字段>=1 | 启用双读模式 | restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-06/<YYYY-MM-DD_HHMM>` | Diagnostics Owner |
| ProjectM 多版本歧义 | browser-console engine 标识 | 同轮出现 prod+exp | 关实验引擎 | restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-04/<YYYY-MM-DD_HHMM>` | Rendering Owner |
| 音频背压掉帧 | S3 + baseline compare | 连续2轮 jitter 上升>10% 或 page-errors>0 | 切旧背压参数 | restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P1-09/<YYYY-MM-DD_HHMM>` | Audio Owner |

## 6) 可复制看板（GitHub Issues/Notion风格）
### Week1
- Issue P0-00（Owner: Tech Lead，标签：P0/blocking/tooling）
  - 影响面：`scripts/metrics/*`, `scripts/ci/*`, `scripts/scenarios/*`, `scripts/verify-dev.mjs`, `scripts/verify-check.mjs`
  - 验收Checklist
    - [ ] 所有新增脚本可执行
    - [ ] `verify:dev/check` 通过
  - 回滚Checklist
    - [ ] restore：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/rollback/restore-from-snapshot.ps1 -Snapshot artifacts/snapshots/P0-00/<YYYY-MM-DD_HHMM>`
- Issue P0-01（Owner: Tech Lead）
- Issue P0-02（Owner: Tech Lead）
- Issue P0-03（Owner: Tech Lead）
- Issue P0-04（Owner: Rendering Owner）

### Week2
- Issue P0-05（Owner: Tech Lead）
- Issue P1-06（Owner: Diagnostics Owner）
- Issue P1-07（Owner: Preset Owner）
- Issue P1-08（Owner: Rendering Owner）

### Week3
- Issue P1-09（Owner: Audio Owner）
- Issue P2-10（Owner: Tech Lead）
- Issue P2-11（Owner: Diagnostics Owner）
- Issue P2-12（Owner: Tech Lead）
- RC Signoff（Owner: Tech Lead）

## 7) 附录
### A. 一键采样脚本入口
- PowerShell：`powershell -NoProfile -ExecutionPolicy Bypass -File scripts/metrics/sample-baseline.ps1 -Runs 5 -Report artifacts/headless/report.json -Out artifacts/headless/baseline-summary.json`
- bash：`bash scripts/metrics/sample-baseline.sh 5 artifacts/headless/report.json artifacts/headless/baseline-summary.json`

### B. 场景 S1/S2/S3 压测脚本方案
- 入口：`node scripts/scenarios/run-s1.mjs`、`node scripts/scenarios/run-s2.mjs`、`node scripts/scenarios/run-s3.mjs`
- 接入：`scripts/verify-dev.mjs --scenarios` 时调用并汇总到 `artifacts/headless/report.json`

### C. 产物路径约定
- `artifacts/headless/report.json`
- `artifacts/headless/browser-console.log`
- `artifacts/headless/page-errors.log`
- `artifacts/headless/dev-server.log`
- `logs/aivj-selection.log`
- `artifacts/headless/scenario-s1.json`
- `artifacts/headless/scenario-s2.json`
- `artifacts/headless/scenario-s3.json`
- `artifacts/headless/baseline-summary.json`
- `artifacts/headless/report-field-map.json`

### D. 要新增的脚本列表（路径 + 用途 + 门禁调用）
- `scripts/metrics/map-report-fields.mjs`：字段映射；verify:dev 后分析
- `scripts/metrics/sample-baseline.ps1`：PowerShell 采样；Day1/Day15
- `scripts/metrics/sample-baseline.sh`：bash 采样；Day1/Day15
- `scripts/metrics/hash-report-subset.mjs`：行为不变证明；P0-00/P0-03/P2-10
- `scripts/metrics/hash-dist-structure.mjs`：构建结构证明；P0-05
- `scripts/metrics/compare-baseline.mjs`：基线比对；P0-03/P1-08/P1-09
- `scripts/ci/validate-artifact-schema.mjs`：schema 校验；verify:check
- `scripts/ci/doc-gate-consistency.mjs`：文档一致性；P0-02/P2-12
- `scripts/ci/compare-selection-log.mjs`：预设一致性；P1-07
- `scripts/ci/runbook-smoke.mjs`：手册冒烟；P2-12
- `scripts/scenarios/run-s1.mjs`：S1 压测；verify:dev --scenarios
- `scripts/scenarios/run-s2.mjs`：S2 压测；verify:dev --scenarios
- `scripts/scenarios/run-s3.mjs`：S3 压测；verify:dev --scenarios
- `scripts/scenarios/snapshot-points.mjs`：截图点 hash；P0-03/P1-08

### E. 假设清单
- 仓库根目录为 `newliveweb`
- `verify:dev` 持续产出 `artifacts/headless/report.json`
- `verify:check` 可作为唯一发布硬门禁
- AI/coupled 功能可通过开关保持实验态
- 允许在仓库内新增轻量脚本，不更改外部行为
- 训练窗口内仅执行对允许小文件的只读访问

### F. Coupled 质量产物验证（Step A/B/C，避免“写废数据”）

> 适用场景：当你生成/刷新 `public/presets/<PACK>/pairs-quality.v0.json` 后，先按本节做硬验证；  
> 只要 A/B/C 任意一项不成立，下一步就不是“继续训练”，而是先修加载路径/策略/日志证据或修训练信号塌缩。

约定占位符：

- `<REPO_ROOT>` = `newliveweb` 仓库根目录
- `<PACK>` = `ai_generated_coupled_final`（或你要测的 pack）
- `<DEV_URL>` = dev 地址（通常 `http://127.0.0.1:5174/`）

#### Step A：证明 runtime 真的加载了 `pairs-quality.v0.json`（10 分钟）

1) 文件存在性（不扫大目录）

```powershell
cd <REPO_ROOT>

$pack = "<PACK>"
$q = ".\\public\\presets\\$pack\\pairs-quality.v0.json"
$m = ".\\public\\presets\\$pack\\pairs-manifest.v0.json"

"manifest exists: " + (Test-Path $m)
"quality exists:   " + (Test-Path $q)
```

2) `qualityStats.std` 是否达标（避免“学成常数”）

```powershell
cd <REPO_ROOT>

$pack = "<PACK>"
$q = ".\\public\\presets\\$pack\\pairs-quality.v0.json"

$j = Get-Content $q -Raw | ConvertFrom-Json
[pscustomobject]@{
  pack = $pack
  std = $j.qualityStats.std
  p50 = $j.qualityStats.p50
  p95 = $j.qualityStats.p95
  min = $j.qualityStats.min
  max = $j.qualityStats.max
} | Format-List
```

判定口径：

- ✅ `std >= 0.03`：分数有区分度，值得进入 runtime 用 `weighted`
- ❌ `std < 0.03`：分数接近常数，runtime 用它也不会明显改变选择分布

3) 证明“页面运行时确实 fetch 了这个 JSON”（关键证据）

- 打开：`<DEV_URL>?coupled=1&coupledPack=<PACK>&coupledPick=weighted`
- DevTools -> Network -> 过滤 `pairs-quality.v0.json` -> 刷新
- 预期：`/presets/<PACK>/pairs-quality.v0.json` 返回 200，Response 含 `qualityStats/pairs[]`

4) （已落地）Console 证据：`coupledPairsLoader.ts` 会打印加载成功/失败

- 成功：`[coupled-pairs] loaded pairs-quality { pack, url, std, pairs }`
- 失败：`[coupled-pairs] failed to load pairs-quality ...`

#### Step B：行为对照实验（30~60 分钟）：证明 `weighted` 改变选择分布

目标：同一个 `<PACK>`、同样时长/迭代，`weighted` 下被选中的 pair 更偏向高 `quality01`。

1) 两次运行：只改一个变量 `coupledPick`

- Run1（shuffle）：`<DEV_URL>?coupled=1&coupledPack=<PACK>&coupledPick=shuffle`
- Run2（weighted）：`<DEV_URL>?coupled=1&coupledPack=<PACK>&coupledPick=weighted`

公平性要求（必须同源）：

- 同 pack、同运行时长/迭代次数、同切换频率
- 同 GPU 模式（不要一边 SwiftShader 一边 4090）

2) 两份“选择序列”落盘

你需要能从日志提取每次选择的 `pair=<n>`（或 JSON 片段 `"pair": <n>`）。  
如果当前日志没有 pair 信息：先补“每次切换输出一行 pair”的日志（后续任务会加到统一选择日志里）。

3) 用脚本对照（只看分布，不看画面）

脚本：`scripts/metrics/compare-coupled-pick.ps1`

```powershell
cd <REPO_ROOT>

powershell -NoProfile -ExecutionPolicy Bypass -File scripts/metrics/compare-coupled-pick.ps1 `
  -Pack "<PACK>" `
  -ShuffleLog "artifacts/headless/sel.shuffle.log" `
  -WeightedLog "artifacts/headless/sel.weighted.log"
```

你要的“硬结论”：

- `avgQuality`：weighted 应该 > shuffle
- `top20HitRate`：weighted 应该 > shuffle

#### Step C：训练契约 SSOT（20 分钟）

单页真相源：`docs/TRAINING_CONTRACT.md`  
它回答 4 件事：训练吃什么、产物是什么、runtime 怎么用、怎么验收。
