# AI 协作记录 / Prompt 提示约定

> 目的：在多位 AI 同时开发前后端时，统一上下文和约定，避免互相踩坑
## 当前分工（示例，可继续补充）

- 前端：UI/渲染/随机与收藏逻辑、manifest 加载、库模式切换- 后端/炼丹：manifest 生成与筛选、wasm 兼容检查、projectM CLI 调试- 新增摄像LiDAR 协作：前端已`src/camera/*` `CameraLayer` 占位，后WebRTC/深度流可按此接口接入
## 接口 / 约束

- Layer 接口固定：`src/layers/Layer.ts`（init/update/onResize/dispose）。添加新视觉层（如未Camera/LiDAR）请新建 `Layer` 实现，不要修改现有层- SceneManager 作为渲染 orchestrator，不在其中写业务逻辑；新增层请通过 addLayer 注册- 配置与数据流：`config/*`、`lib/*`；避免把全局配置散落在组件内
## 提示/ 操作规约

- 避免改动对方正在处理的文件时重写逻辑；若需修改共享文件，请在这里先记一笔- 端口使用：dev 建议 5174（或任意5173 的稳定端口）；preview 默认 4173，如占用请修改命令行参数- 运行命令：`npm run dev -- --host 127.0.0.1 --port <port> --strictPort`；预览需`npm run build`，再 `npm run preview -- --host --port <port>`.

## 变更记录（按时间追加
- 2025-12-11：创建本协作记录，约Layer 接口SceneManager 不嵌业务逻辑；前后端分工如上- 2025-12-17：Refactor step 1：抽BG/Camera 热开关到 `src/app/controllers/backgroundMixerUiController.ts`，`bootstrap.ts` 改为 controller 注入并删`getLayerEnabled/syncBackgroundMixerToggles/startCameraEnableHint`；验收：`npm run lint` 通过，`VERIFY_PORT=5176 npm run verify:dev` 通过174 在本机出EACCES）- 2025-12-17：Refactor step 2：抽toolbar 收起/展开`src/app/controllers/toolbarCollapsedController.ts`；`bootstrap.ts` 改用 `initToolbarCollapsedController`；验收：`npm run lint` 通过，`VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 3：抽UI 面板透明度到 `src/app/controllers/uiOpacityController.ts`；`bootstrap.ts` 删除 `UI_OPACITY_KEY/clampUiOpacityPct/setUiOpacityPct` 并改`initUiOpacityController`；验收：`npm run lint` 通过，`VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 4：抽`navigator.mediaDevices` devicechange 监听`src/app/controllers/mediaDevicesChangeController.ts`；`bootstrap.ts` 改用 `initMediaDevicesChangeController`；验收：`npm run lint` 通过，`VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Docs step：在 `TODOS.zh.md` 勾选“UI 透明度可调”为已完成，并补齐落点与验收命令；验收：`npm run lint` + `VERIFY_PORT=5176 npm run verify:dev`- 2025-12-17：UI/Diagnostics step：`DiagnosticsPanel` inline style，改`.nw-diag-row/.nw-diag-label/.nw-diag-value` 语义DOM（`src/features/console/DiagnosticsPanel.ts` + `src/style.css`）；验收：`VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：UI/Favorites step：收藏夹多收藏横向对比表（含 CSV 导出）已验收；验收：`npm run lint` + `VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Headless verify step：新增自动验收收藏夹对比（`artifacts/headless/report.json` `checks.favoritesCompare.ok=true`）；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：LiquidMetal step：补`uPaletteStrength` stars/lines 变体生效（默0 数学等价不变）；验收：`VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 5：抽Random/Favorite/收藏夹开+ R 快捷键到 `src/app/controllers/visualActionsController.ts`，并把自动加载测试音轨逻辑移动audioTransport 初始化后（修tsc 对闭包内 `audioController` 的错误收窄）；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 6：抽Favorites storage/migration/panel/countLabel `src/app/controllers/favoritesController.ts`，`bootstrap.ts` 改用 controller（`addFavorite/togglePanel`）；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 7：抽MIDI 连接/学习/绑定与参数映射到 `src/app/controllers/midiController.ts`，`bootstrap.ts` 改用 `midiController.refreshTargets()` 同步 slot/背景变化；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 8：抽Macro Slots（新渲染/编辑/Randomize/Pin）到 `src/app/controllers/macroSlotsController.ts`，`bootstrap.ts` `renderMacroSlots()` 变为薄封装；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Refactor step 9：抽Show/Save show 配置（读保存/应用）到 `src/app/controllers/showConfigController.ts`，`bootstrap.ts` 改为注入 controller 并统一 dispose；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过
- 2025-12-17：Refactor step 10：抽Inspector（参数检搜索/advanced/reset/camera device select）到 `src/app/controllers/inspectorController.ts`，`src/app/bootstrap.ts` 只保`applyInspectorPatch` 并委`render/refreshStatus`；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Hotfix：修`bootstrap.ts` 残留 `inspectorOpen/inspectorQuery/inspectorShowAdvanced` 引用导致的真实交ReferenceError，补`initInspectorController` 接线；同时增稳定 `scripts/headless-verify.mjs`（确inspector 处于打开态、mixer 检查前清空搜索、降toolbar/ProjectM 截图波动影响、去report.checks.userFlow 字段）；验收：`npm run lint` + `VERIFY_PORT=5176 npm run verify:dev` 通过（page-errors.log 为空）- 2025-12-17：Hotfix：为 `src/app/controllers/audioTransportController.ts` 补齐 `dispose()`（移UI/window/seek 事件监听、取Mixxx 重试），并在 `src/app/bootstrap.ts` unload/HMR 清理中调用；同时增强 `scripts/headless-verify.mjs` mixer blend check 以抵抗中HMR/page reload；验收：`npm run lint` + `VERIFY_PORT=5176 npm run verify:dev` 通过（page-errors.log 为空）- 2025-12-17：Audio/Camera step：DJM 立体声分析（L/R splitter + max 合成 三频“舞台化”包络（`src/audio/stageBands.ts` 光谱 flux + Meyda 特征（centroid/loudness/flatness/zcr 可MediaPipe 人像分割（`Background/Camera/segmentPerson`，本地资`public/vendor/mediapipe/selfie_segmentation`，同步脚`npm run sync:mediapipe`）；验收：`npm run lint` + `VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev` 通过- 2025-12-17：Lifecycle scan：补`src/app/bootstrap.ts` 的“非 controller”事件监timeout 清理（跟踪并unload/HMR dispose 中统一 teardown，避免热更新重复绑定），并在 `beforeunload` 增加 `cameraLayer/videoLayer/projectLayer` dispose；验收：`npm run lint` + `VERIFY_PORT=5176 npm run verify:dev` 通过（page-errors.log 为空）
## 待办 / 交接事项

- 如需新增模块/接口，请在此列出目的、文件路径、对现有代码的约束

- 2025-12-17: Audio/BeatTempo (Essentia.js) optional Worker + Inspector scope audio.beatTempo (default disabled); verified: npm run lint + VERIFY_HOST=127.0.0.1 VERIFY_PORT=5176 npm run verify:dev; NOTE: essentia.js is AGPL-3.0.
