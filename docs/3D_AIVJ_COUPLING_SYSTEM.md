# 3D AIVJ 双层耦合系统设计文档

> 目标: 构建超越MilkDrop2077的3D双层音乐可视化系统
> 日期: 2026-01-31

---

## 现状资产盘点

### 已有数据 (D:\aidata)
| 目录 | 数量 | 说明 |
|------|------|------|
| ai_generated_premium | 10,000 | 高质量200行+预设 |
| ai_generated_quality | 1,000 | 中等质量77行预设 |
| ai_generated_v2 | 5,000 | 优化参数预设 |
| ai_generated_coupled_final | 8,041对 | 现有3D耦合数据 |
| **总计** | **~32,000** | 7天炼丹产物 |

### 外部资源
| 资源 | 数量 | 来源 |
|------|------|------|
| MilkDrop 130k+ MegaPack | 120,000+ | 社区收集 |
| MilkDrop2077源码 | - | GitHub开源 |

### 可用原料合计: **162,000+ 预设**

---

## 3D AIVJ 核心技术架构

### 双层渲染管线
```
┌─────────────────────────────────────┐
│           最终合成输出               │
├─────────────────────────────────────┤
│  FG Layer (projectLayer)            │
│  - 前景视觉元素                      │
│  - 高warp (1.5x-3x BG)              │
│  - 高透明度 (0.6-0.8)               │
│  - 动态响应音频高频                  │
├─────────────────────────────────────┤
│  BG Layer (projectLayerBg)          │
│  - 背景基础视觉                      │
│  - 低warp (基础值)                  │
│  - 低透明度 (0.3-0.5)               │
│  - 响应音频低频                      │
└─────────────────────────────────────┘
```

### 3D深度感知参数体系

| 参数类型 | BG值 | FG值 | 差异策略 |
|----------|------|------|----------|
| warp | 1.0-2.5 | 1.5x-2.5x BG | FG扭曲更强 |
| zoom | 0.8-1.2 | 1.0-2.0 | FG扩张感 |
| rot | ±0.1 | ±0.3 (相反方向) | 旋转干涉 |
| cx | 0.5 | 0.5 ± 0.1 | 水平视差 |
| decay | 0.90 | 0.85-0.95 | 拖尾差异 |

---

## 智能配对生成算法

### 阶段1: 风格标签化 (利用32k数据)
```python
# 对现有32k预设进行自动分类
styles = {
    'spiral': {'rot': >0.3, 'warp': 1.5-3},
    'explosive': {'warp': >3.5, 'decay': >0.92},
    'implosive': {'zoom': <0.8},
    'wave': {'wave_mode': [2,4,7]},
    'chaotic': {'warp': >5},
    'minimal': {'complexity': <50},
    'shapecode': {'has_shapes': True}
}
```

### 阶段2: 3D耦合配对策略
```
策略矩阵 (BG风格 × FG风格):
┌─────────────┬──────────────────────────────────────┐
│ BG \ FG     │ 推荐组合                              │
├─────────────┼──────────────────────────────────────┤
│ spiral      │ explosive (旋转+爆炸=时空漩涡)        │
│ minimal     │ wave (简约+波形=呼吸感)               │
│ implosive   │ expansive (收缩+扩张=脉冲心跳)        │
│ chaotic     │ minimal (混乱+简约=对比层次)          │
│ wave        │ spiral (波形+旋转=流体3D)             │
└─────────────┴──────────────────────────────────────┘
```

### 阶段3: 参数耦合计算
```
Coupling Formula (耦合公式):

# 空间耦合 (视差)
cx_fg = cx_bg + k_spatial * sin(ω*t + phase)
cx_bg = cx_bg - k_spatial * sin(ω*t + phase)

# 时间耦合 (旋转干涉)
rot_fg = rot_base + A * sin(ω*t)
rot_bg = rot_base - A * sin(ω*t)  # 相反方向

# Warp耦合 (强度互相影响)
warp_fg = warp_bg * (1 + k_warp * depth_factor)
```

---

## 实施路线图

### Phase 1: 数据整合 (1天)
- [x] 扫描32k现有预设
- [x] 提取参数特征
- [x] 自动风格分类
- [ ] 质量评分筛选
- [ ] 建立配对候选池

### Phase 2: 3D配对生成 (3天)
- [ ] 实现风格矩阵配对
- [ ] 耦合参数计算
- [ ] 批量生成10,000对
- [ ] 人工抽样验证

### Phase 3: AIVJ集成 (2天)
- [ ] 前端配对加载器
- [ ] 实时切换逻辑
- [ ] 音频响应映射
- [ ] 性能优化

### Phase 4: 迭代优化 (持续)
- [ ] 收集使用数据
- [ ] 热门配对分析
- [ ] 自动生成新配对

---

## 关键技术决策

### 为什么不继续深度学习？
1. **产出效率**: 7天32k预设 vs 10分钟零产出
2. **可控性**: 规则-based更易调试
3. **可解释性**: 知道为什么生成这样
4. **资源效率**: 不需要GPU训练

### MilkDrop2077借鉴点
- ✅ 预设杂交(Mashing)核心思路
- ✅ 智能变异策略
- ✅ 参数范围保护

### 超越MilkDrop2077的点
- 🚀 双层3D耦合 (MD2077是单层)
- 🚀 音频响应配对 (BG/FG响应不同频段)
- 🚀 大规模自动化 (162k原料 → 无限产出)

---

## 预期产出

```
输入: 162,000 预设
输出: 50,000+ 3D耦合对
质量: 人工筛选通过率 >80%
创新性: 超越原有预设的简单混合
```

---

## 下一步行动

1. **立即执行**: 启动3D配对生成器
2. **并行进行**: 前端集成开发
3. **验证闭环**: 实际渲染测试
